<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Master-Doc - File conversion</title>
    <meta name="description" content="">
    <meta name="author" content="Martin Deudon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="https://tinmard.github.io/theme/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="https://tinmard.github.io/theme/bootstrap.min.css" rel="stylesheet">
    <link href="https://tinmard.github.io/theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="https://tinmard.github.io/theme/local.css" rel="stylesheet">
    <link href="https://tinmard.github.io/theme/pygments.css" rel="stylesheet">

    <!--TIPUE SEARCH  old -->
    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>-->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/Tipue-Search/5.0.0/tipuesearch.js"></script>-->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/Tipue-Search/5.0.0/tipuesearch_set.js"></script>-->
    <!--<link rel ="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Tipue-Search/5.0.0/tipuesearch.css"/>-->
    <!--<link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css">-->
    <!--<script src="https://tinmard.github.io/theme/js/jquery-3.3.1.min.js"></script>-->
    <!--<script type="text/javascript" src="https://tinmard.github.io/theme/tipuesearch/tipuesearch_content.js"></script>-->
    <!--<link rel="stylesheet" href="https://tinmard.github.io/theme/tipuesearch/tipuesearch.css">-->
    <!--<script type="text/javascript" src="https://tinmard.github.io/theme/tipuesearch/tipuesearch_set.js"></script>-->
    <!--<script type="text/javascript" src="https://tinmard.github.io/theme/tipuesearch/tipuesearch.min.js"></script>-->
    <!--TIPUE SEARCH -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css">
    <script src="https://tinmard.github.io/theme/tipuesearch/tipuesearch_content.js"></script>
    <link rel="stylesheet" href="https://tinmard.github.io/theme/tipuesearch/tipuesearch.css">
    <!--<script src="tipuesearch/tipuesearch_set.js"></script>-->
    <!--<script src="tipuesearch/tipuesearch.min.js"></script>-->
    <script src="https://tinmard.github.io/theme/tipuesearch/tipuesearch_set.js"></script>
    <script src="https://tinmard.github.io/theme/tipuesearch/tipuesearch.min.js"></script>


    <!-- So Firefox can bookmark->"abo this site" -->
        <link href="https://tinmard.github.io/feeds/all.atom.xml" rel="alternate" title="Master-Doc" type="application/atom+xml">

</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href="https://tinmard.github.io">Master-Doc</a>

        <div class="nav-collapse">
        <ul class="nav">
            <li><a href="/sab/index.html">SAB</a></li>
            <li><a href="/epifar/index.html">Epifar</a></li>
            <li><a href="/stimic/index.html">Stimic</a></li>
            <li><a href="/cochlea/index.html">Cochlea</a></li>
            <li><a href="/neurons/index.html">Neurons</a></li>

        </ul>
        </div>

        <!--TIPUE SEARCH old-->
        <!--<div style="float:right; padding-right:100px;">-->
            <!--<form action="https://tinmard.github.io/search.html" onsubmit="return this.elements['q'].value;">-->
              <!--<input id="tipue_search_input" type="text" name="q" placeholder="Search">-->
            <!--</form>-->
        <!--</div>-->
        <form>
            <div class="tipue_search_group">
              <input type="text" name="q" id="tipue_search_input" pattern=".{3,}" title="At least 3 characters" required><button type="submit" class="tipue_search_button"><div class="tipue_search_icon">&#9906;</div></button>
            </div>
        </form>

<div id="tipue_search_content"></div>

    </div>
    </div>
</div>


<div class="container">

    <div class="content">
    <div class="row">

        <div class="span9">
    <div class='article'>
        <div class="content-title">
            <h1>File conversion</h1>
lun. 22 octobre 2018

by <a class="url fn" href="https://tinmard.github.io/author/martin-deudon.html">Martin Deudon</a>
 


        </div>

        <div class="col-lg-3 hidden-xs hidden-sm">
            <div id="toc"><ul><li><a class="toc-href" href="#" title="File conversion">File conversion</a><ul><li><a class="toc-href" href="#summary" title="Summary">Summary</a></li><li><a class="toc-href" href="#format-conversion" title="Format conversion">Format conversion</a><ul><li><a class="toc-href" href="#blackrock-nsx-files" title="Blackrock NSx files">Blackrock NSx files</a><ul><li><a class="toc-href" href="#matlab" title="Matlab">Matlab</a></li><li><a class="toc-href" href="#python" title="Python">Python</a></li></ul></li><li><a class="toc-href" href="#neuralynx-files_1" title="Neuralynx files">Neuralynx files</a></li></ul></li><li><a class="toc-href" href="#new-montage_1" title="New montage">New montage</a><ul><li><a class="toc-href" href="#macro-files-monopolar-to-bipolar" title="Macro files : monopolar to bipolar">Macro files : monopolar to bipolar</a></li><li><a class="toc-href" href="#micro-files" title="Micro files">Micro files</a></li></ul></li><li><a class="toc-href" href="#epifar-files_1" title="EpiFaR files">EpiFaR files</a></li></ul></li></ul></div>
        </div>
	
        <div><h1 id="summary">Summary</h1>
<p>The Matlab code is on the <a href="https://github.com/tinmarD/eegFileConversion">eegFileConversion</a> repository.</p>
<p>Conversion scripts are listed in the table below with their main function : </p>
<table>
<thead>
<tr>
<th align="center">Function</th>
<th align="center">file</th>
<th align="center">misc.</th>
<th align="center">Down-sampling</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><code>Format Conversion</code></td>
<td align="center"><em>fileconv_nsx2edf()</em></td>
<td align="center"></td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><em>nsx2eeglab()</em></td>
<td align="center"></td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><em>dirconv_nsx2edf</em></td>
<td align="center"></td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center"><code>Mono-to-bipolar</code></td>
<td align="center"><em>fileconv_mono2bipolar_macro()</em></td>
<td align="center"></td>
<td align="center">No</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><em>fileconv_mono2bipolar_micro()</em></td>
<td align="center"></td>
<td align="center">No</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><em>mono2bipolar_macro()</em></td>
<td align="center"></td>
<td align="center">No</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><em>mono2bipolar_micro()</em></td>
<td align="center"></td>
<td align="center">No</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><em>dirconv_mono2bipolar_macro</em></td>
<td align="center"></td>
<td align="center">No</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><em>dirconv_mono2bipolar_micro</em></td>
<td align="center"></td>
<td align="center">No</td>
</tr>
<tr>
<td align="center"><code>Synchronization</code></td>
<td align="center"><em>filesync_macromicro()</em></td>
<td align="center"></td>
<td align="center">No</td>
</tr>
<tr>
<td align="center"><code>Divide</code></td>
<td align="center"><em>filedivide_edf()</em></td>
<td align="center"></td>
<td align="center">No</td>
</tr>
<tr>
<td align="center"><code>Downsampling</code></td>
<td align="center"><em>fileconv_downsample_edf()</em></td>
<td align="center"></td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><em>dirconv_downsample_edf</em></td>
<td align="center"></td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center"><code>EpiFaR</code></td>
<td align="center"><em>jediconv</em></td>
<td align="center"></td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><em>jediconv_dir</em></td>
<td align="center"></td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><em>yodaconv</em></td>
<td align="center">Experimental</td>
<td align="center">Yes</td>
</tr>
</tbody>
</table>
<p><img src="/images/warning.png" width="20"/> All these scripts detect EEG channels based on the assumption that these channels' 
name start with <em>'EEG '</em>. This convention must be respected for the scripts to work <img src="/images/warning.png" width="20"/></p>
<p>In most of the scripts, you can specify the names of the bad channels, with the variable/argument <code>badChannelNames</code> which
must be a cell containing the names of the bad channels. These channels will be removed.</p>
<h1 id="format-conversion">Format conversion</h1>
<h2 id="blackrock-nsx-files">Blackrock NSx files</h2>
<p>Blackrock files are saved in NS5/NEV format. The data are contained in the NS5 file, the NEV file can contain other 
information such as the triggers.</p>
<h3 id="matlab">Matlab</h3>
<p>To open the Blackrock file in Matlab, the <a href="https://github.com/BlackrockMicrosystems/NPMK">NPMK</a> toolbox is needed. 
It contains a lot a useful function include <em>openNSx()</em> which allows to load NSx files into Matlab.</p>
<p><strong>Open a NS5 file in Matlab with the <em>fileconv_nsx2edf</em> function</strong>. It writes an EDF file in the <em>edf_dirpath</em> and downsample
the data by 10.</p>
<div class="highlight"><pre><span></span><span class="nt">nsx_dir</span> <span class="o">=</span> <span class="s1">'C:\TestFiles\NSX'</span><span class="o">;</span>  
<span class="nt">nsx_filename</span> <span class="o">=</span> <span class="s1">'20200410-144200-001.ns5'</span><span class="o">;</span>
<span class="nt">edf_dirpath</span> <span class="o">=</span> <span class="s1">'C:\TestFiles\EDF'</span><span class="o">;</span>

<span class="nt">downsampling_factor</span> <span class="o">=</span> <span class="nt">10</span><span class="o">;</span> 
<span class="cp">[</span><span class="nx">out_dirpath</span><span class="p">,</span> <span class="nx">out_filename</span><span class="p">,</span> <span class="nx">EEGs</span><span class="cp">]</span> <span class="o">=</span> <span class="nt">fileconv_nsx2edf</span><span class="o">(</span><span class="nt">nsx_dir</span><span class="o">,</span> <span class="nt">nsx_filename</span><span class="o">,</span> <span class="nt">-1</span><span class="o">,</span> <span class="nt">downsampling_factor</span><span class="o">);</span>
</pre></div>
<p>You can find a visual document showing the correspondencies between EEGLAB and Blackrock fields 
<a href="{filename}/data/eeg/fileconversion/eeglab_nsx_correpondency.pdf">here</a></p>
<h3 id="python">Python</h3>
<p>In python you can use the <a href="https://github.com/NeuralEnsemble/python-neo">neo</a> package.</p>
<blockquote>
<p>In python, there is no easy way to write data into the EDF file format
 (the <em>pyedflib</em> package is complex). The <em>.fif</em> format is a good alternative as it can be opened with 
 <a href="https://tinmard.github.io/micmac.html">micMac</a> and with MNE.</p>
</blockquote>
<p><strong> Import a Blackrock file in Python with <a href="https://martinos.org/mne/stable/index.html">MNE</a> </strong> :</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mne</span>
<span class="kn">import</span> <span class="nn">neo</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="n">nsx_filepath</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">'C:\TestFiles\NSX</span>

<span class="n">bl</span> <span class="o">=</span> <span class="n">neo_loader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cascade</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">seg</span> <span class="o">=</span> <span class="n">bl</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">n_pnts</span><span class="p">,</span> <span class="n">n_chan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">)</span>
<span class="n">ch_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_chan</span><span class="p">,</span> <span class="n">n_pnts</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">asig</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">):</span>
    <span class="n">ch_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asig</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="c1"># We need the ravel() here because Neo &lt; 0.5 gave 1D, Neo 0.5 gives</span>
    <span class="c1"># 2D (but still a single channel).</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">asig</span><span class="o">.</span><span class="n">magnitude</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">sfreq</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sampling_rate</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">create_info</span><span class="p">(</span><span class="n">ch_names</span><span class="o">=</span><span class="n">ch_names</span><span class="p">,</span> <span class="n">sfreq</span><span class="o">=</span><span class="n">sfreq</span><span class="p">)</span>
<span class="n">raw</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">RawArray</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</pre></div>
<p>Then you can save the raw MNE structure easily (in <em>.fif</em> format for example)</p>
<h2 id="neuralynx-files_1">Neuralynx files</h2>
<p>With Blackrock files (<em>nsX</em>), all the channels  are stored in the same file and the file can be divided
 into several time periods. In Neuralynx format (<em>ncs</em>), each channel is stored in a separate file and can also 
 be segmented into different time periods.</p>
<p>The <a href="https://github.com/tinmarD/eegFileConversion">eegFileConversion</a> repository contain some scripts for converting
Neuralynx files to EDF. You will need the NeuraLynx <a href="https://neuralynx.com/software/category/matlab-netcom-utilities"><em>MATLAB Import/Export MEX Files</em></a></p>
<p><img src="/images/warning.png" width="20"/> These functions are a bit experimental and you should not rely too much on the ouput result <img src="/images/warning.png" width="20"/> </p>
<p>With Neuralynx format, each channel is separated in a different file, and there may be several files for a single channel.
The scripts differs in the following way : </p>
<ul>
<li><code>CSCdir_to_EDF_divide</code> : merge the channels together but do NOT merge the different files together</li>
<li><code>CSCdir_to_EDF_merge</code> : merge the channels together and merge also the different files together.</li>
<li><code>CSCconv_writedatatoedf</code> : function used by the two other scripts to contruct an EEGLAB structure from the data and convert it into an <em>.edf</em> file.</li>
</ul>
<p>These scripts also separate the micro and the Macro channels which are in the same <em>.ncs</em> files.  The way it discriminate
micro and Macro channels is based on the channel name. It may not work if different naming convention are used !</p>
<h1 id="new-montage_1">New montage</h1>
<p>The scripts and functions for creating a new montage use both EEGLAB and ERPLAB. </p>
<h2 id="macro-files-monopolar-to-bipolar">Macro files : monopolar to bipolar</h2>
<p>The naming convention for bipolar files is to append <em>'_b'</em> to the file name</p>
<ul>
<li><code>mono2bipolar_macro</code> : main mono-to-bipolar conversion function. Take as argument and return an EEGLAB structure.</li>
<li><code>fileconv_mono2bipolar_macro</code> : wrapper around <em>mono2bipolar_macro</em> function. Write the bipolar <em>.edf</em> file.</li>
<li><code>dirconv_mono2bipolar_macro</code> : wrapper around <em>mono2bipolar_macro</em> function. Convert all <em>.edf</em> files in a directory into bipolar <em>.edf</em> files </li>
</ul>
<h2 id="micro-files">Micro files</h2>
<p>There are more possible montage for micro tetrodes that for macro electrodes. We have used mainly three montages so far : </p>
<table>
<thead>
<tr>
<th align="center">Reference commune (monopolar)</th>
<th align="center">Inter-tetrode</th>
<th align="center">Intra-tetrode</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><img src="/images/eeg/file_conversion/ref_commune.png"/></td>
<td align="center"><img src="/images/eeg/file_conversion/inter_tetrode.png"/></td>
<td align="center"><img src="/images/eeg/file_conversion/intra_tetrode.png"/></td>
</tr>
<tr>
<td align="center">Ref. is a macro-contact in the white matter</td>
<td align="center">Ref. is a contact from another tetrode on the same electrode</td>
<td align="center">Ref. is a contact from the same tetrode</td>
</tr>
</tbody>
</table>
<ul>
<li><code>mono2bipolar_micro</code> : main mono-to-bipolar conversion function. Take as argument and return an EEGLAB structure.</li>
<li><code>fileconv_mono2bipolar_macro</code> : wrapper around <em>mono2bipolar_macro</em> function. Write the bipolar <em>.edf</em> file.</li>
<li><code>dirconv_mono2bipolar_macro</code> : wrapper around <em>mono2bipolar_macro</em> function. Convert all <em>.edf</em> files in a directory into bipolar <em>.edf</em> files </li>
</ul>
<p>The inter and intra tetrode montage has to be done manually. Modify the <em>mono2bipolar_micro</em> file, you have to specify the 
tetrode names <code>microNames</code>, the number of channels per tetodre <code>nChanPerMicro</code> (8 or 12) and the bipolar montage <code>bipolarMontage</code>.
The <code>bipolarMontage</code> variable is a cell of vectors. Each vector defines the new channels for a single electrode. </p>
<div class="highlight"><pre><span></span>case 34 % P34
    microNames              = {'b','tb','b'''}; 
    nChanPerMicro           = [12,8,12];
    bipolarMontage          = {[ 1,5;2,6;3,7;4,8;5,9;6,10;7,11;8,12;1,9;2,10;3,11;4,12],...
                               [ 1,5;2,6;3,7;4,8],...
                               [ 1,5;2,6;3,7;4,8;5,9;6,10;7,11;8,12;1,9;2,10;3,11;4,12]};
</pre></div>
<h1 id="epifar-files_1">EpiFaR files</h1>
<p>Several files are dedicated to the conversion of EpiFaR files and offer an automated pipeline : </p>
<ol>
<li>Convert the micro <em>.ns5</em> file into an <em>.edf</em>, downsample it if needed and divide it into 10-minutes segments.</li>
<li>Synchronize the Macro <em>.edf</em> file with the micro file. If the Macro file starts before, cut the beginning the macro
  file. If the Macro starts after, add a blank signal at the beginning of the macro file</li>
<li>Divide the Macro synchronized file in 10-minutes segments</li>
<li>Convert the Macro monopolar file into bipolar files</li>
<li>Convert the micro monopolar file into bipolar files. </li>
</ol>
<p>Some of these step are not mandatory and can be commented in the <code>jediconv</code> file. All the files starting with <code>jediconv</code>
deal with EpiFaR files. The <code>yodaconv</code> file can be used when the micro file is discontinued and composed of several parts. 
However this script has not been tested thoroughly. </p></div>
	
        <hr>

    </div>
        </div>

        <div class="span3">

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header">
                Site
                </li>

                <li><a href="https://tinmard.github.io/archives.html">Archives</a>
                <li><a href="https://tinmard.github.io/tags.html">Tags</a>



                <li><a href="https://tinmard.github.io/feeds/all.atom.xml" rel="alternate">Atom feed</a></li>

            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header">
                Categories
                </li>

                <li><a href="https://tinmard.github.io/category/eeg.html">eeg</a></li>
                <li><a href="https://tinmard.github.io/category/misc.html">misc</a></li>
                <li><a href="https://tinmard.github.io/category/projects.html">projects</a></li>
                <li><a href="https://tinmard.github.io/category/python.html">python</a></li>
                <li><a href="https://tinmard.github.io/category/software.html">software</a></li>
            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header">
                Links
                </li>

                <li><a href="http://cerco.ups-tlse.fr/">CerCo</a></li>
                <li><a href="http://python.org/">Python.org</a></li>
            </ul>
            </div>


            <div class="social">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header">
                Social
                </li>

                <li><a href="https://github.com/tinmarD">github</a></li>
            </ul>
            </div>
            </div>

        </div>     </div>     </div> 

<footer>
<br />
<p><a href="https://tinmard.github.io">Master-Doc</a> &copy; Martin Deudon 2018</p>
</footer>
</div> <!-- /container -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="https://tinmard.github.io/theme/bootstrap-collapse.js"></script>
</body>
</html>