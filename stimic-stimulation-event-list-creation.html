<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Master-Doc - Stimic - Stimulation Event List Creation</title>
    <meta name="description" content="">
    <meta name="author" content="Martin Deudon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="https://tinmard.github.io/theme/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="https://tinmard.github.io/theme/bootstrap.min.css" rel="stylesheet">
    <link href="https://tinmard.github.io/theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="https://tinmard.github.io/theme/local.css" rel="stylesheet">
    <link href="https://tinmard.github.io/theme/pygments.css" rel="stylesheet">

    <!--TIPUE SEARCH old -->
    <!--<link rel="stylesheet" href="https://tinmard.github.io/theme/tipuesearch/tipuesearch.css"-->
    <!--<script src="https://tinmard.github.io/theme/js/jquery-3.3.1.min.js" type="text/javascript"></script>-->

    <!--TIPUE SEARCH -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css">
    <script src="/theme/tipuesearch/tipuesearch_content.js"></script>
    <link rel="stylesheet" href="tipuesearch/css/tipuesearch.css">
    <script src="/theme/tipuesearch/tipuesearch_set.js"></script>
    <script src="/theme/tipuesearch/tipuesearch.min.js"></script>


    <!-- So Firefox can bookmark->"abo this site" -->
        <link href="https://tinmard.github.io/feeds/all.atom.xml" rel="alternate" title="Master-Doc" type="application/atom+xml">

</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href="https://tinmard.github.io">Master-Doc</a>

        <div class="nav-collapse">
        <ul class="nav">
            <li><a href="/sab/index.html">SAB</a></li>
            <li><a href="/epifar/index.html">Epifar</a></li>
            <li><a href="/stimic/index.html">Stimic</a></li>
            <li><a href="/cochlea/index.html">Cochlea</a></li>
            <li><a href="/neurons/index.html">Neurons</a></li>

        </ul>
        </div>

        <!--TIPUE SEARCH-->
        <section>
            <form class="navbar-search" action="https://tinmard.github.io/search.html" onsubmit="return this.elements['q'].value;">
                <input type="text" class="search-query" placeholder="" name="q" id="tipue_search_input">
                <input type="submit" value="Go!">
            </form></li>
        </section>

    </div>
    </div>
</div>


<div class="container">

    <div class="content">

    <div class="row">

        <div class="span9">
    <div class='article'>
        <div class="content-title">
            <h1>Stimic - Stimulation Event List Creation</h1>
jeu. 08 novembre 2018

by <a class="url fn" href="https://tinmard.github.io/author/martin-deudon.html">Martin Deudon</a>
 


        </div>

        <div class="col-lg-3 hidden-xs hidden-sm">
            <div id="toc"><ul><li><a class="toc-href" href="#" title="Stimic - Stimulation Event List Creation">Stimic - Stimulation Event List Creation</a><ul><li><a class="toc-href" href="#artifact-detection-in-macro-electrodes" title="Artifact Detection in macro-electrodes">Artifact Detection in macro-electrodes</a><ul><li><a class="toc-href" href="#description" title="Description">Description</a></li><li><a class="toc-href" href="#stimulation-parameters" title="Stimulation Parameters">Stimulation Parameters</a></li></ul></li><li><a class="toc-href" href="#pipeline_1" title="Pipeline">Pipeline</a></li><li><a class="toc-href" href="#output-spreadsheet" title="Output spreadsheet">Output spreadsheet</a></li><li><a class="toc-href" href="#epoch-creation" title="Epoch creation">Epoch creation</a></li></ul></li></ul></div>
        </div>
	
        <div><p>This article describes the procedure used for listing all the stimulations events through a semi-automated pipeline.</p>
<h2 id="artifact-detection-in-macro-electrodes">Artifact Detection in macro-electrodes</h2>
<h3 id="description">Description</h3>
<p><strong>Goal</strong> :  Detect (semi)-automatically stimulation artifacts on the macro-signals. Detection output must give the onset time of the stim, the channel(s) of stimulations and the frequency of the stim. A visual confirmation will be necessary before using the results. Here we only concentrate on locating the stimulation on the stimulation channels, with monopolar montage.</p>
<p>This will help to create a spreadsheet for each patient containing all the stimulation events and  parameters :</p>
<ul>
<li>Patient ID</li>
<li>Stimulation File Name</li>
<li>Channel / Electrode</li>
<li>Onset Time (s)</li>
<li>Duration (s)</li>
<li>Frequency (Hz)</li>
<li>Intensity (mA?)</li>
<li>Effect on the patient (if any)</li>
</ul>
<h3 id="stimulation-parameters">Stimulation Parameters</h3>
<p>Both frequency and intensity of the stimulation can change and affect the artifacts waveforms. The duration of the stimulation can also change but as we are only interested in detection the onset time, we will not consider it.</p>
<ul>
<li>Frequency range between 1Hz and 50Hz</li>
<li>Intensity range between 0.5 mA and 4-5 mA</li>
</ul>
<h2 id="pipeline_1">Pipeline</h2>
<p>For each patient, for each file : </p>
<ul>
<li>
<p>1 - Run the python script <code>stim_clean_EDF_files.py</code> which open all the EDF files, remove the non-EEG channels and bad channels. The script also check that each file contains the same number of channels and are ordered in the same way across each file. If a channel is missing, an NaN channel id added. It creates new FIF files</p>
</li>
<li>
<p>2 - For each file created in step 1, run the python script <code>stim_detection_main.py</code> which automatically detects the period of stimulation. It create an output csv file containing the events detected by the algorithm. Make sure that the frequencies of stimulations apart from 1 and 50 Hz are in the list called <em>mid_freqs_hz</em>.</p>
</li>
</ul>
<p>Columns of interest are :</p>
<div class="highlight"><pre><span></span>   - 4 : Type of the stimulation
   - 5 : Time (in seconds)
   - 8 : Duration (in seconds)
   - 7 : Channel index
</pre></div>
<ul>
<li>
<p>3 - Visual check of the events : run <em>micMac</em> in Matlab and open the FIF file (<em>Signals / Load Raw Signal / FIF Files</em>). Import the csv file created in 1. Go in Events/Import/External Events. Indicate the correct columns number (You can use the <strong>Auto-detect button</strong>. <strong>Check the "zero-index for channel" checkbox</strong> . Check that the stimulation events are correct and manually add the missing ones. Once done, make sure to <strong>sort the event by time</strong> and <strong>export the events</strong>. It create another csv file, with this time all the stimulation events.</p>
</li>
<li>
<p>4 - Use the python script <code>stim_frommicmactoexcel.py</code>, for each csv file. It will convert and reorganized the micMac event file into an Excel file.</p>
</li>
<li>
<p>5 - Convert the micro <em>.NS5</em> file into <em>.edf</em> files using the conversion Matlab function <em>fileconv_nsx2edf</em>. Use a downsampling factor of 6 to get a sampling frequency of 5kHz.</p>
</li>
<li>
<p>6 - Run the Python script <code>stim_macrotomicro_corr_file.py</code> for each <em>fif</em> and <em>csv</em> file. First you will need to find the time offset between the macro-file and the micro-file : micMac can be 
used, load the 2 files and either find the time offset manually or use the <a href="https://micmac.readthedocs.io/en/latest/signals/resynch_signals.html">Resynch signals</a> tool.</p>
</li>
<li>
<p>7 - Concatenate all the excel sheet into one, to get all the stimulations data into 1 file.</p>
</li>
</ul>
<h2 id="output-spreadsheet">Output spreadsheet</h2>
<p>The output spreadsheet will looks like this.This will allow to run further analysis.</p>
<p><img src="/images/stimic/stim_list/output_spreadsheet_example.png" width="900"/></p>
<h2 id="epoch-creation">Epoch creation</h2>
<p>Once the Excel file containing all the event is done, an MNE Epoch structure can be created using the 
 <code>stim_create_epoch.py</code> script. 
It takes as input the path to the excel stimulation file and the path pointing to the cleaned data directory.</p>
<p>3 options are available: </p>
<ul>
<li><em>resynch</em> : If True, resynchronize the onset of the stimulation</li>
<li><em>inverse_neg_stim</em> : If True, inverse the negative stimulation so that all stimulation appears positive and the mean is not biased</li>
<li><em>select_all_channels</em> :  If True select all the channel for creating the epoch, otherwise select only the stimulation channel</li>
</ul></div>
	
        <hr>

    </div>
            <div class="article">
                <!--TIPUE SEARCH--><div id="tipue_search_content"></div>
            </div>
        </div>

        <div class="span3">

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header">
                Site
                </li>

                <li><a href="https://tinmard.github.io/archives.html">Archives</a>
                <li><a href="https://tinmard.github.io/tags.html">Tags</a>



                <li><a href="https://tinmard.github.io/feeds/all.atom.xml" rel="alternate">Atom feed</a></li>

            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header">
                Categories
                </li>

                <li><a href="https://tinmard.github.io/category/eeg.html">eeg</a></li>
                <li><a href="https://tinmard.github.io/category/misc.html">misc</a></li>
                <li><a href="https://tinmard.github.io/category/projects.html">projects</a></li>
                <li><a href="https://tinmard.github.io/category/python.html">python</a></li>
                <li><a href="https://tinmard.github.io/category/software.html">software</a></li>
            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header">
                Links
                </li>

                <li><a href="http://cerco.ups-tlse.fr/">CerCo</a></li>
                <li><a href="http://python.org/">Python.org</a></li>
            </ul>
            </div>


            <div class="social">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header">
                Social
                </li>

                <li><a href="https://github.com/tinmarD">github</a></li>
            </ul>
            </div>
            </div>

        </div>     </div>     </div> 


<footer>
<br />
<p><a href="https://tinmard.github.io">Master-Doc</a> &copy; Martin Deudon 2019</p>
</footer>
</div> <!-- /container -->
<!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>-->
<!--<script src="https://tinmard.github.io/theme/bootstrap-collapse.js"></script>-->


</body>
</html>